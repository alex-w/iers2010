#include "earth_rotation.hpp"
#include "geodesy/units.hpp"
#include "sofa.h"
#include <array>
#include <cstdio>
#include <random>
#ifdef NDEBUG
#undef NDEBUG
#endif
#include <cassert>

struct TestOrbit {
  double mjd, x, y, z;
};
constexpr const std::array<TestOrbit, 289> orbv = {{
  { 59644.000000000000000, 20792075.932999998, 16904298.643999998, 3153728.644000000 },
{ 59644.003472222218988, 20801492.295000002, 17005808.283999998, 2221491.836000000 },
{ 59644.006944444445253, 20786718.675000001, 17084436.150000002, 1285188.197000000 },
{ 59644.010416666664241, 20746697.533000000, 17141078.776999999, 346526.183000000 },
{ 59644.013888888890506, 20680443.265999999, 17176703.844000001, -592772.839000000 },
{ 59644.017361111109494, 20587047.112000000, 17192345.995000001, -1530977.266000000 },
{ 59644.020833333335759, 20465681.788000003, 17189102.377999999, -2466348.044000000 },
{ 59644.024305555554747, 20315605.875000000, 17168127.896000002, -3397141.495000000 },
{ 59644.027777777781012, 20136167.906999998, 17130630.203000002, -4321612.262000000 },
{ 59644.031250000000000, 19926810.160000000, 17077864.434000000, -5238016.287000000 },
{ 59644.034722222218988, 19687072.101000000, 17011127.721000001, -6144613.891000000 },
{ 59644.038194444445253, 19416593.498999998, 16931753.476999998, -7039672.916000000 },
{ 59644.041666666664241, 19115117.168000001, 16841105.490999997, -7921471.918000001 },
{ 59644.045138888890506, 18782491.316000000, 16740571.855999999, -8788303.454000000 },
{ 59644.048611111109494, 18418671.513000000, 16631558.726000000, -9638477.388000000 },
{ 59644.052083333335759, 18023722.214000002, 16515483.966000000, -10470324.290000001 },
{ 59644.055555555554747, 17597817.880999997, 16393770.677000001, -11282198.845000001 },
{ 59644.059027777781012, 17141243.632999998, 16267840.667000001, -12072483.329000000 },
{ 59644.062500000000000, 16654395.466000002, 16139107.843000000, -12839591.098999999 },
{ 59644.065972222218988, 16137779.984999999, 16008971.607999999, -13581970.118999999 },
{ 59644.069444444445253, 15592013.677999999, 15878810.245000001, -14298106.493999999 },
{ 59644.072916666664241, 15017821.709000001, 15749974.343000000, -14986528.007999999 },
{ 59644.076388888890506, 14416036.216000000, 15623780.299000001, -15645807.666999999 },
{ 59644.079861111109494, 13787594.143000001, 15501503.904999999, -16274567.210999999 },
{ 59644.083333333335759, 13133534.567000000, 15384374.073000001, -16871480.609999999 },
{ 59644.086805555554747, 12454995.573000001, 15273566.720999999, -17435277.509000000 },
{ 59644.090277777781012, 11753210.609999999, 15170198.855000000, -17964746.634999998 },
{ 59644.093750000000000, 11029504.434000000, 15075322.871000001, -18458739.110999998 },
{ 59644.097222222218988, 10285288.546000000, 14989921.124000000, -18916171.719999999 },
{ 59644.100694444445253, 9522056.216000000, 14914900.775000000, -19336030.046999998 },
{ 59644.104166666664241, 8741377.083999999, 14851088.970000001, -19717371.521000002 },
{ 59644.107638888890506, 7944891.323000000, 14799228.354000000, -20059328.343000002 },
{ 59644.111111111109494, 7134303.464000000, 14759972.976000000, -20361110.250000000 },
{ 59644.114583333335759, 6311375.812000000, 14733884.582999999, -20622007.148000002 },
{ 59644.118055555554747, 5477921.579000000, 14721429.356000001, -20841391.559999999 },
{ 59644.121527777781012, 4635797.666000000, 14722975.092000000, -21018720.899000000 },
{ 59644.125000000000000, 3786897.224000000, 14738788.855999999, -21153539.533999998 },
{ 59644.128472222218988, 2933141.936000000, 14769035.129000001, -21245480.655999999 },
{ 59644.131944444445253, 2076474.132000000, 14813774.467000000, -21294267.910999998 },
{ 59644.135416666664241, 1218848.737000000, 14872962.671000000, -21299716.798000000 },
{ 59644.138888888890506, 362225.089000000, 14946450.501000000, -21261735.820999999 },
{ 59644.142361111109494, -491441.293000000, 15033983.919000000, -21180327.383000001 },
{ 59644.145833333335759, -1340207.010000000, 15135204.882999999, -21055588.412000000 },
{ 59644.149305555554747, -2182149.024000000, 15249652.683000000, -20887710.710999999 },
{ 59644.152777777781012, -3015372.897000000, 15376765.815000001, -20676981.028999999 },
{ 59644.156250000000000, -3838020.873000000, 15515884.396000000, -20423780.846000001 },
{ 59644.159722222218988, -4648279.858000000, 15666253.106000001, -20128585.864000000 },
{ 59644.163194444445253, -5444389.182000000, 15827024.638999999, -19791965.213000000 },
{ 59644.166666666664241, -6224648.125000000, 15997263.654000001, -19414580.361000001 },
{ 59644.170138888890506, -6987423.181000000, 16175951.206000000, -18997183.730000000 },
{ 59644.173611111109494, -7731154.979000000, 16361989.627999999, -18540617.037000000 },
{ 59644.177083333335759, -8454364.867000001, 16554207.844000001, -18045809.335999999 },
{ 59644.180555555554747, -9155661.072999999, 16751367.085000001, -17513774.800000001 },
{ 59644.184027777781012, -9833744.461000001, 16952166.967000000, -16945610.221000001 },
{ 59644.187500000000000, -10487413.789000001, 17155251.912000000, -16342492.266999999 },
{ 59644.190972222218988, -11115570.504999999, 17359217.863000002, -15705674.473999999 },
{ 59644.194444444445253, -11717223.002999999, 17562619.261000000, -15036484.022000000 },
{ 59644.197916666664241, -12291490.327000000, 17763976.242000002, -14336318.280999999 },
{ 59644.201388888890506, -12837605.341000000, 17961782.017000001, -13606641.148000000 },
{ 59644.204861111109494, -13354917.289999999, 18154510.388000000, -12848979.214000002 },
{ 59644.208333333335759, -13842893.791000001, 18340623.362999998, -12064917.729000000 },
{ 59644.211805555554747, -14301122.209999999, 18518578.816000000, -11256096.452000000 },
{ 59644.215277777781012, -14729310.459000001, 18686838.167000003, -10424205.319999998 },
{ 59644.218750000000000, -15127287.160000000, 18843874.024000000, -9570980.057999998 },
{ 59644.222222222218988, -15495001.242000001, 18988177.748999998, -8698197.634000000 },
{ 59644.225694444445253, -15832520.925999999, 19118266.914999999, -7807671.680000001 },
{ 59644.229166666664241, -16140032.135000000, 19232692.599999998, -6901247.844000001 },
{ 59644.232638888890506, -16417836.352999998, 19330046.492000002, -5980799.092000000 },
{ 59644.236111111109494, -16666347.907000000, 19408967.768999998, -5048221.013000000 },
{ 59644.239583333335759, -16886090.759000000, 19468149.702000000, -4105427.104000000 },
{ 59644.243055555554747, -17077694.765000001, 19506345.978000000, -3154344.097000000 },
{ 59644.246527777781012, -17241891.478000000, 19522376.686000001, -2196907.291000000 },
{ 59644.250000000000000, -17379509.487999998, 19515133.953000002, -1235055.978000000 },
{ 59644.253472222218988, -17491469.363000002, 19483587.200999998, -270728.895000000 },
{ 59644.256944444445253, -17578778.192000002, 19426788.008000001, 694140.212000000 },
{ 59644.260416666664241, -17642523.778999999, 19343874.544999998, 1657626.926000000 },
{ 59644.263888888890506, -17683868.536000002, 19234075.581000000, 2617820.415000000 },
{ 59644.267361111109494, -17704043.074000001, 19096714.041999999, 3572827.526000000 },
{ 59644.270833333335759, -17704339.579999998, 18931210.094999999, 4520776.788000000 },
{ 59644.274305555554747, -17686104.965000000, 18737083.791000001, 5459822.232000001 },
{ 59644.277777777781012, -17650733.859000001, 18513957.208000001, 6388147.107000000 },
{ 59644.281250000000000, -17599661.473000001, 18261556.136999998, 7303967.397000000 },
{ 59644.284722222218988, -17534356.362999998, 17979711.283000000, 8205535.210000000 },
{ 59644.288194444445253, -17456313.147000000, 17668358.996999998, 9091141.982999999 },
{ 59644.291666666664241, -17367045.186999999, 17327541.540999997, 9959121.516999999 },
{ 59644.295138888890506, -17268077.296999998, 16957406.878999997, 10807852.858000001 },
{ 59644.298611111109494, -17160938.487999998, 16558208.041999998, 11635762.977000000 },
{ 59644.302083333335759, -17047154.800999999, 16130302.014000000, 12441329.309000000 },
{ 59644.305555555554747, -16928242.237000000, 15674148.222999999, 13223082.086000001 },
{ 59644.309027777781012, -16805699.838000000, 15190306.592999998, 13979606.533000000 },
{ 59644.312500000000000, -16681002.928999998, 14679435.213000001, 14709544.857000001 },
{ 59644.315972222218988, -16555596.552999999, 14142287.608000001, 15411598.103000000 },
{ 59644.319444444445253, -16430889.123000002, 13579709.650000000, 16084527.824999999 },
{ 59644.322916666664241, -16308246.316000002, 12992636.140000001, 16727157.603000000 },
{ 59644.326388888890506, -16188985.232000001, 12382087.029000001, 17338374.411000002 },
{ 59644.329861111109494, -16074368.820000000, 11749163.373000000, 17917129.819999997 },
{ 59644.333333333335759, -15965600.620999999, 11095042.966000000, 18462441.071000002 },
{ 59644.336805555554747, -15863819.811999999, 10420975.750000000, 18973391.989999998 },
{ 59644.340277777781012, -15770096.580000000, 9728278.939999999, 19449133.789000001 },
{ 59644.343750000000000, -15685427.841999998, 9018331.979000000, 19888885.710999999 },
{ 59644.347222222218988, -15610733.312000001, 8292571.258000000, 20291935.574999999 },
{ 59644.350694444445253, -15546851.931000000, 7552484.680000000, 20657640.186000001 },
{ 59644.354166666664241, -15494538.664999999, 6799606.085000000, 20985425.638000000 },
{ 59644.357638888890506, -15454461.676000001, 6035509.517000000, 21274787.509999998 },
{ 59644.361111111109494, -15427199.876000000, 5261803.425000000, 21525290.957000002 },
{ 59644.364583333335759, -15413240.859999999, 4480124.736000000, 21736570.708000001 },
{ 59644.368055555554747, -15412979.229000000, 3692132.915000000, 21908330.965000000 },
{ 59644.371527777781012, -15426715.288999999, 2899503.943000000, 22040345.226000000 },
{ 59644.375000000000000, -15454654.147000000, 2103924.310000000, 22132456.015999999 },
{ 59644.378472222218988, -15496905.183000000, 1307084.981000000, 22184574.546000000 },
{ 59644.381944444445253, -15553481.900999999, 510675.412000000, 22196680.294000000 },
{ 59644.385416666664241, -15624302.163000001, -283622.405000000, 22168820.524000000 },
{ 59644.388888888890506, -15709188.791000001, -1074139.842000000, 22101109.732000001 },
{ 59644.392361111109494, -15807870.533000000, -1859227.427000000, 21993729.033000000 },
{ 59644.395833333335759, -15919983.394000001, -2637260.574000000, 21846925.484999999 },
{ 59644.399305555554747, -16045072.314999999, -3406645.154000000, 21661011.366999999 },
{ 59644.402777777781012, -16182593.196000000, -4165822.972000000, 21436363.384000000 },
{ 59644.406250000000000, -16331915.249000000, -4913277.052000000, 21173421.842000000 },
{ 59644.409722222218988, -16492323.688000001, -5647536.793000001, 20872689.756000001 },
{ 59644.413194444445253, -16663022.716000000, -6367182.910000000, 20534731.912999999 },
{ 59644.416666666664241, -16843138.824000001, -7070852.192000001, 20160173.900000002 },
{ 59644.420138888890506, -17031724.381999999, -7757242.051000000, 19749701.061999999 },
{ 59644.423611111109494, -17227761.499000002, -8425114.825000001, 19304057.438999999 },
{ 59644.427083333335759, -17430166.155999999, -9073301.872000000, 18824044.638999999 },
{ 59644.430555555554747, -17637792.581000000, -9700707.377000000, 18310520.675999999 },
{ 59644.434027777781012, -17849437.873000000, -10306311.930000000, 17764398.753000002 },
{ 59644.437500000000000, -18063846.829000000, -10889175.796000000, 17186646.017999999 },
{ 59644.440972222218988, -18279716.995999999, -11448441.925999999, 16578282.243000001 },
{ 59644.444444444445253, -18495703.899000000, -11983338.664000001, 15940378.484999999 },
{ 59644.447916666664241, -18710426.447999999, -12493182.131999999, 15274055.683000000 },
{ 59644.451388888890506, -18922472.498999998, -12977378.343000000, 14580483.204000000 },
{ 59644.454861111109494, -19130404.559999999, -13435424.945999999, 13860877.351000000 },
{ 59644.458333333335759, -19332765.608000003, -13866912.687000001, 13116499.794000000 },
{ 59644.461805555554747, -19528085.020999998, -14271526.499000000, 12348655.981000001 },
{ 59644.465277777781012, -19714884.578000002, -14649046.291000001, 11558693.450999999 },
{ 59644.468750000000000, -19891684.544000000, -14999347.358000001, 10748000.130000001 },
{ 59644.472222222218988, -20057009.780000001, -15322400.472999999, 9918002.534000000 },
{ 59644.475694444445253, -20209395.892000001, -15618271.617000001, 9070163.925999999 },
{ 59644.479166666664241, -20347395.384000000, -15887121.352000000, 8205982.415000000 },
{ 59644.482638888890506, -20469583.783000000, -16129203.864000000, 7326988.959000000 },
{ 59644.486111111109494, -20574565.745999999, -16344865.630000001, 6434745.345000001 },
{ 59644.489583333335759, -20660981.094000001, -16534543.753000002, 5530842.049000000 },
{ 59644.493055555554747, -20727510.773000002, -16698763.934999999, 4616896.069999999 },
{ 59644.496527777781012, -20772882.713999998, -16838138.125000000, 3694548.652000000 },
{ 59644.500000000000000, -20795877.571000002, -16953361.798000000, 2765462.965000000 },
{ 59644.503472222218988, -20795334.308000002, -17045210.931000002, 1831321.676000000 },
{ 59644.506944444445253, -20770155.630000003, -17114538.631000001, 893824.471000000 },
{ 59644.510416666664241, -20719313.217000000, -17162271.444000002, -45314.508000000 },
{ 59644.513888888890506, -20641852.745999999, -17189405.370999999, -984369.325000000 },
{ 59644.517361111109494, -20536898.689000003, -17197001.562000003, -1921604.953000000 },
{ 59644.520833333335759, -20403658.846999999, -17186181.741000000, -2855280.093000000 },
{ 59644.524305555554747, -20241428.618999999, -17158123.342999998, -3783650.037000000 },
{ 59644.527777777781012, -20049594.961999997, -17114054.403999999, -4704969.636000000 },
{ 59644.531250000000000, -19827640.050000001, -17055248.196000002, -5617496.313000000 },
{ 59644.534722222218988, -19575144.575999998, -16983017.645000000, -6519493.174000001 },
{ 59644.538194444445253, -19291790.721000001, -16898709.539999999, -7409232.173000000 },
{ 59644.541666666664241, -18977364.732999999, -16803698.544000000, -8284997.337000000 },
{ 59644.545138888890506, -18631759.114000000, -16699381.062000001, -9145088.070000000 },
{ 59644.548611111109494, -18254974.419000000, -16587168.941000000, -9987822.489000000 },
{ 59644.552083333335759, -17847120.599000003, -16468483.071999999, -10811540.839000000 },
{ 59644.555555555554747, -17408417.939999998, -16344746.880999999, -11614608.916999999 },
{ 59644.559027777781012, -16939197.530000001, -16217379.774000000, -12395421.571000000 },
{ 59644.562500000000000, -16439901.283000000, -16087790.518999999, -13152406.186000001 },
{ 59644.565972222218988, -15911081.478000000, -15957370.639000000, -13884026.232000001 },
{ 59644.569444444445253, -15353399.831000000, -15827487.808000000, -14588784.793000001 },
{ 59644.572916666664241, -14767626.094999999, -15699479.306000000, -15265228.103000000 },
{ 59644.576388888890506, -14154636.150000000, -15574645.547000000, -15911949.089000000 },
{ 59644.579861111109494, -13515409.640000001, -15454243.729000000, -16527590.865999999 },
{ 59644.583333333335759, -12851027.097000001, -15339481.613000000, -17110850.223000001 },
{ 59644.586805555554747, -12162666.617999999, -15231511.490000000, -17660481.043000001 },
{ 59644.590277777781012, -11451600.028000001, -15131424.350000000, -18175297.685000002 },
{ 59644.593750000000000, -10719188.631999999, -15040244.290000001, -18654178.267000001 },
{ 59644.597222222218988, -9966878.468000000, -14958923.196000000, -19096067.887000002 },
{ 59644.600694444445253, -9196195.153000001, -14888335.721999999, -19499981.726000004 },
{ 59644.604166666664241, -8408738.308000000, -14829274.603000000, -19865008.039000001 },
{ 59644.607638888890506, -7606175.568000000, -14782446.334000001, -20190311.021000002 },
{ 59644.611111111109494, -6790236.248000001, -14748467.221999999, -20475133.516000003 },
{ 59644.614583333335759, -5962704.621000000, -14727859.872000001, -20718799.574999999 },
{ 59644.618055555554747, -5125412.919000001, -14721050.096999999, -20920716.831000000 },
{ 59644.621527777781012, -4280234.004000000, -14728364.293000001, -21080378.693999998 },
{ 59644.625000000000000, -3429073.821000000, -14750027.298999999, -21197366.324999999 },
{ 59644.628472222218988, -2573863.600000000, -14786160.748000000, -21271350.416000001 },
{ 59644.631944444445253, -1716551.897000000, -14836781.942000000, -21302092.721000001 },
{ 59644.635416666664241, -859096.489000000, -14901803.242000001, -21289447.355000000 },
{ 59644.638888888890506, -3456.154000000, -14981032.003000000, -21233361.840000000 },
{ 59644.642361111109494, 848417.579000000, -15074171.044000000, -21133877.888000000 },
{ 59644.645833333335759, 1694588.727000000, -15180819.665999999, -20991131.910000000 },
{ 59644.649305555554747, 2533145.086000000, -15300475.208000001, -20805355.260000002 },
{ 59644.652777777781012, 3362206.422000000, -15432535.153999999, -20576874.176000003 },
{ 59644.656250000000000, 4179932.504000000, -15576299.761000000, -20306109.451000001 },
{ 59644.659722222218988, 4984531.012000000, -15730975.215000000, -19993575.805000000 },
{ 59644.663194444445253, 5774265.198000000, -15895677.289999999, -19639880.959999997 },
{ 59644.666666666664241, 6547461.308000000, -16069435.503999999, -19245724.441999998 },
{ 59644.670138888890506, 7302515.717999999, -16251197.736000000, -18811896.067000002 },
{ 59644.673611111109494, 8037901.707000000, -16439835.291999999, -18339274.169000000 },
{ 59644.677083333335759, 8752175.885000000, -16634148.385000000, -17828823.522999998 },
{ 59644.680555555554747, 9443984.175999999, -16832872.011000000, -17281593.019000001 },
{ 59644.684027777781012, 10112067.384000000, -17034682.165999997, -16698713.050999999 },
{ 59644.687500000000000, 10755266.253000000, -17238202.399000000, -16081392.668000000 },
{ 59644.690972222218988, 11372526.049000001, -17442010.636999998, -15430916.472000001 },
{ 59644.694444444445253, 11962900.590000000, -17644646.256999999, -14748641.296000000 },
{ 59644.697916666664241, 12525555.725000000, -17844617.370000001, -14035992.667000001 },
{ 59644.701388888890506, 13059772.261000000, -18040408.254999999, -13294461.060000001 },
{ 59644.704861111109494, 13564948.280000001, -18230486.923000000, -12525597.991000000 },
{ 59644.708333333335759, 14040600.892000001, -18413312.761000000, -11731011.919000000 },
{ 59644.711805555554747, 14486367.347999999, -18587344.199000001, -10912364.036000000 },
{ 59644.715277777781012, 14902005.604000000, -18751046.383000001, -10071363.887000000 },
{ 59644.718750000000000, 15287394.220000001, -18902898.789999999, -9209764.932000000 },
{ 59644.722222222218988, 15642531.726000000, -19041402.752000000, -8329359.979000000 },
{ 59644.725694444445253, 15967535.356000001, -19165088.853000000, -7431976.566000001 },
{ 59644.729166666664241, 16262639.225000001, -19272524.150000002, -6519472.304000000 },
{ 59644.732638888890506, 16528191.955999998, -19362319.182999998, -5593730.163000001 },
{ 59644.736111111109494, 16764653.751000002, -19433134.754999999, -4656653.782000001 },
{ 59644.739583333335759, 16972592.959000003, -19483688.414000001, -3710162.753000000 },
{ 59644.743055555554747, 17152682.140000001, -19512760.644000001, -2756187.965000000 },
{ 59644.746527777781012, 17305693.684000000, -19519200.706000000, -1796666.956000000 },
{ 59644.750000000000000, 17432494.967000000, -19501932.127000000, -833539.364000000 },
{ 59644.753472222218988, 17534043.131999999, -19459957.789999999, 131257.589000000 },
{ 59644.756944444445253, 17611379.484000001, -19392364.622000001, 1095793.489000000 },
{ 59644.760416666664241, 17665623.548000000, -19298327.861000001, 2058149.030000000 },
{ 59644.763888888890506, 17697966.838000000, -19177114.864000000, 3016420.216000000 },
{ 59644.767361111109494, 17709666.354000002, -19028088.488000002, 3968722.407000000 },
{ 59644.770833333335759, 17702037.859000001, -18850709.980000000, 4913194.256000000 },
{ 59644.774305555554747, 17676448.956000000, -18644541.416999999, 5848001.478000000 },
{ 59644.777777777781012, 17634312.030000001, -18409247.661000002, 6771340.497000000 },
{ 59644.781250000000000, 17577077.057000000, -18144597.846999999, 7681441.893000000 },
{ 59644.784722222218988, 17506224.351000000, -17850466.384000000, 8576573.732000001 },
{ 59644.788194444445253, 17423257.254999999, -17526833.492999997, 9455044.693000000 },
{ 59644.791666666664241, 17329694.834999997, -17173785.285999998, 10315207.037000000 },
{ 59644.795138888890506, 17227064.600000001, -16791513.361000001, 11155459.414000001 },
{ 59644.798611111109494, 17116895.271000002, -16380313.986000000, 11974249.471999999 },
{ 59644.802083333335759, 17000709.661000002, -15940586.802999999, 12770076.324999999 },
{ 59644.805555555554747, 16880017.655999999, -15472833.153999999, 13541492.816000000 },
{ 59644.809027777781012, 16756309.361000000, -14977653.949999999, 14287107.634000000 },
{ 59644.812500000000000, 16631048.422000000, -14455747.194000000, 15005587.245000001 },
{ 59644.815972222218988, 16505665.541999999, -13907905.090000000, 15695657.676000001 },
{ 59644.819444444445253, 16381552.236000000, -13335010.813000001, 16356106.114000000 },
{ 59644.822916666664241, 16260054.827000000, -12738034.947000001, 16985782.364999998 },
{ 59644.826388888890506, 16142468.718000000, -12118031.585000001, 17583600.151999999 },
{ 59644.829861111109494, 16030032.943000000, -11476134.157000000, 18148538.263999999 },
{ 59644.833333333335759, 15923925.034000000, -10813550.954000000, 18679641.564000003 },
{ 59644.836805555554747, 15825256.198999999, -10131560.437000001, 19176021.850000001 },
{ 59644.840277777781012, 15735066.841000000, -9431506.264000000, 19636858.602000002 },
{ 59644.843750000000000, 15654322.416999999, -8714792.168000000, 20061399.570000000 },
{ 59644.847222222218988, 15583909.653999999, -7982876.591999999, 20448961.275000002 },
{ 59644.850694444445253, 15524633.135000000, -7237267.202000000, 20798929.366000000 },
{ 59644.854166666664241, 15477212.243000001, -6479515.242000001, 21110758.880000003 },
{ 59644.857638888890506, 15442278.498000000, -5711209.766000000, 21383974.395000000 },
{ 59644.861111111109494, 15420373.261999998, -4933971.789000000, 21618170.079000000 },
{ 59644.864583333335759, 15411945.838000000, -4149448.347000000, 21813009.647999998 },
{ 59644.868055555554747, 15417351.943000000, -3359306.526000000, 21968226.230999999 },
{ 59644.871527777781012, 15436852.578000000, -2565227.432000000, 22083622.155000001 },
{ 59644.875000000000000, 15470613.276000001, -1768900.185000000, 22159068.643999998 },
{ 59644.878472222218988, 15518703.730999999, -972015.893000000, 22194505.447000001 },
{ 59644.881944444445253, 15581097.812000001, -176261.675000000, 22189940.390000001 },
{ 59644.885416666664241, 15657673.946999999, 616685.258000000, 22145448.866000000 },
{ 59644.888888888890506, 15748215.878000000, 1405163.484000000, 22061173.252000000 },
{ 59644.892361111109494, 15852413.779000001, 2187533.117000000, 21937322.274999999 },
{ 59644.895833333335759, 15969865.732000001, 2962181.490000000, 21774170.309000000 },
{ 59644.899305555554747, 16100079.548000000, 3727528.675000000, 21572056.629000001 },
{ 59644.902777777781012, 16242474.935000001, 4482032.896000000, 21331384.598000001 },
{ 59644.906250000000000, 16396385.983000001, 5224195.750000000, 21052620.814999998 },
{ 59644.909722222218988, 16561063.984000001, 5952567.287000000, 20736294.206000000 },
{ 59644.913194444445253, 16735680.547000000, 6665750.872000000, 20382995.068000000 },
{ 59644.916666666664241, 16919331.024000000, 7362407.852000000, 19993374.068000000 },
{ 59644.920138888890506, 17111038.209999997, 8041262.020000000, 19568141.197000001 },
{ 59644.923611111109494, 17309756.318000000, 8701103.814999999, 19108064.672000002 },
{ 59644.927083333335759, 17514375.217000000, 9340794.314999999, 18613969.800999999 },
{ 59644.930555555554747, 17723724.911000002, 9959268.937000001, 18086737.794000000 },
{ 59644.934027777781012, 17936580.246000003, 10555540.898000000, 17527304.535000000 },
{ 59644.937500000000000, 18151665.839000002, 11128704.372000000, 16936659.307999998 },
{ 59644.940972222218988, 18367661.197000001, 11677937.380999999, 16315843.465000000 },
{ 59644.944444444445253, 18583206.026000001, 12202504.371000001, 15665949.061999999 },
{ 59644.947916666664241, 18796905.705000002, 12701758.478000000, 14988117.437999999 },
{ 59644.951388888890506, 19007336.907000002, 13175143.493999999, 14283537.733999999 },
{ 59644.954861111109494, 19213053.353000000, 13622195.494999999, 13553445.387000000 },
{ 59644.958333333335759, 19412591.680000000, 14042544.151000001, 12799120.533000000 },
{ 59644.961805555554747, 19604477.401999999, 14435913.681000000, 12021886.395000000 },
{ 59644.965277777781012, 19787230.951000001, 14802123.504999999, 11223107.572000001 },
{ 59644.968750000000000, 19959373.772000000, 15141088.500000000, 10404188.314000001 },
{ 59644.972222222218988, 20119434.452000000, 15452818.958000001, 9566570.692000000 },
{ 59644.975694444445253, 20265954.871999998, 15737420.164999999, 8711732.737000000 },
{ 59644.979166666664241, 20397496.355000000, 15995091.631999999, 7841186.501000000 },
{ 59644.982638888890506, 20512645.780999999, 16226125.987000000, 6956476.044000000 },
{ 59644.986111111109494, 20610021.669999998, 16430907.501000002, 6059175.373000000 },
{ 59644.989583333335759, 20688280.184999999, 16609910.276999999, 5150886.283000000 },
{ 59644.993055555554747, 20746121.060000002, 16763696.082999999, 4233236.154999999 },
{ 59644.996527777781012, 20782293.403000001, 16892911.848999999, 3307875.645000000 },
{ 59645.000000000000000, 20795601.381999999, 16998286.819000002, 2376476.337000000 }
}};

/* Celestial-to-terrestrial via SOFA, i.e. [TRS] = rc2t * [CRS] */
Eigen::Matrix<double, 3, 3> sofa(double tt1, double tt2, double ut1, double ut2,
                                 double xp, double yp) {
  double rc2t[3][3];
  iauC2t06a(tt1, tt2, ut1, ut2, xp, yp, rc2t);
  /* copy to output matrix */
  Eigen::Matrix<double, 3, 3> R;
  for (int i = 0; i < 3; i++) {
    for (int j = 0; j < 3; j++) {
      R(i, j) = rc2t[i][j];
    }
  }
  return R;
}

int main() {
  std::uniform_real_distribution<double> unifp(-M_PI / 6, M_PI / 6);
  std::uniform_real_distribution<double> unifs(4e0, 90e0);
  std::default_random_engine re;

  for (const auto &orb : orbv) {

    /* random MJD Epoch */
    const auto mjd = dso::MjdEpoch::random(dso::modified_julian_day(47892),
                                           dso::modified_julian_day(66154));
    const double jd1_tt = mjd.imjd() + dso::MJD0_JD;
    const double jd2_tt = mjd.fractional_days().days();

    /* UT1 */
    const double dut = unifs(re);
    const auto mjd_ut1 = mjd.tt2ut1(dut);
    const double dj1_ut1 = mjd_ut1.imjd() + dso::MJD0_JD;
    const double dj2_ut1 = mjd_ut1.fractional_days().days();

    /* polar motion, random */
    const double xp = unifp(re);
    const double yp = unifp(re);

    /* rotation matrix using SOFA */
    const auto Rsofa = sofa(jd1_tt, jd2_tt, dj1_ut1, dj2_ut1, xp, yp);

    /* store EOP data to an instance */
    dso::EopRecord eops;
    eops.xp() = dso::rad2sec(xp);
    eops.yp() = dso::rad2sec(yp);
    eops.dut() = dut;
    eops.dX() = 0e0;
    eops.dY() = 0e0;

    /* get the equivelant rotation quaternion (this library) */
    const auto Rthis = dso::c2i06a(mjd, eops);

    /* vector to rotate; case A */
    {
      /* tolerances here are set via trial-and-error */
      constexpr const double PTOLERANCE = 1e-3;
      constexpr const double CTOLERANCE = 1e-7;
      constexpr const double STOLERANCE = 1e-7;

      Eigen::Matrix<double, 3, 1> r;
      r << orb.x, orb.y, orb.z;

      /* rotated vector via SOFA */
      Eigen::Vector3d r1 = Rsofa * r;
      /* rotated vector via rotation matrix (this lib) */
      Eigen::Vector3d r2 = Rthis * r;

      // printf("%+.9f %+.9f %+.9f [SOFA]\n", r1(0), r1(1), r1(2));
      // printf("%+.9f %+.9f %+.9f       \n", r2(0), r2(1), r2(2));

      /* compare rotated vectors via SOFA and this lib */
      assert(std::abs(r1(0) - r2(0)) < PTOLERANCE);
      assert(std::abs(r1(1) - r2(1)) < PTOLERANCE);
      assert(std::abs(r1(2) - r2(2)) < PTOLERANCE);

      /* inverse transformation */
      Eigen::Vector3d r11 = Rsofa.transpose() * r1;
      Eigen::Vector3d r22 = Rthis.conjugate() * r2;

      /* closure results, this lib. */
      assert(std::abs(r(0) - r22(0)) < CTOLERANCE);
      assert(std::abs(r(1) - r22(1)) < CTOLERANCE);
      assert(std::abs(r(2) - r22(2)) < CTOLERANCE);

      /* closure results, SOFA */
      assert(std::abs(r(0) - r11(0)) < STOLERANCE);
      assert(std::abs(r(1) - r11(1)) < STOLERANCE);
      assert(std::abs(r(2) - r11(2)) < STOLERANCE);
    }
  }

  return 0;
}
